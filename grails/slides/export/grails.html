<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="description" content="Grails" />
  <meta name="author" content="Adolfo Sanz De Diego" />
  <title>Grails</title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; }
code > span.dt { color: #204a87; }
code > span.dv { color: #0000cf; }
code > span.bn { color: #0000cf; }
code > span.fl { color: #0000cf; }
code > span.ch { color: #4e9a06; }
code > span.st { color: #4e9a06; }
code > span.co { color: #8f5902; font-style: italic; }
code > span.ot { color: #8f5902; }
code > span.al { color: #ef2929; }
code > span.fu { color: #000000; }
code > span.er { font-weight: bold; }
  </style>
</head>
<body>
<header>
<h1 class="title">Grails</h1>
<h2 class="author">Adolfo Sanz De Diego</h2>
<h3 class="date">Abril 2013</h3>
</header>
<nav id="TOC">
<ul>
<li><a href="#acerca-de"><span class="toc-section-number">1</span> Acerca de</a><ul>
<li><a href="#autor"><span class="toc-section-number">1.1</span> Autor</a></li>
<li><a href="#licencia"><span class="toc-section-number">1.2</span> Licencia</a></li>
</ul></li>
<li><a href="#introducción"><span class="toc-section-number">2</span> Introducción</a><ul>
<li><a href="#grails"><span class="toc-section-number">2.1</span> ¿Grails?</a></li>
<li><a href="#paradigmas"><span class="toc-section-number">2.2</span> Paradigmas</a></li>
<li><a href="#gorm"><span class="toc-section-number">2.3</span> GORM</a></li>
<li><a href="#plugins"><span class="toc-section-number">2.4</span> Plugins</a></li>
<li><a href="#nih-not-invented-here"><span class="toc-section-number">2.5</span> NIH (Not Invented Here)</a></li>
<li><a href="#arquitectura"><span class="toc-section-number">2.6</span> Arquitectura</a></li>
</ul></li>
<li><a href="#instalación-y-configuración"><span class="toc-section-number">3</span> Instalación y configuración</a><ul>
<li><a href="#jdk"><span class="toc-section-number">3.1</span> JDK</a></li>
<li><a href="#groovy-sdk"><span class="toc-section-number">3.2</span> Groovy-SDK</a></li>
<li><a href="#grails-1"><span class="toc-section-number">3.3</span> Grails</a></li>
<li><a href="#probando"><span class="toc-section-number">3.4</span> Probando</a></li>
</ul></li>
<li><a href="#getting-started"><span class="toc-section-number">4</span> Getting Started</a><ul>
<li><a href="#create-grails-project"><span class="toc-section-number">4.1</span> Create Grails Project</a></li>
<li><a href="#directorios"><span class="toc-section-number">4.2</span> Directorios</a></li>
<li><a href="#create-a-domain-class"><span class="toc-section-number">4.3</span> Create a Domain Class</a></li>
<li><a href="#create-a-controller"><span class="toc-section-number">4.4</span> Create a Controller</a></li>
<li><a href="#creating-test-data"><span class="toc-section-number">4.5</span> Creating Test Data</a></li>
<li><a href="#start-grails"><span class="toc-section-number">4.6</span> Start Grails</a></li>
</ul></li>
<li><a href="#scaffolding"><span class="toc-section-number">5</span> Scaffolding</a><ul>
<li><a href="#definición"><span class="toc-section-number">5.1</span> Definición</a></li>
<li><a href="#dinámico"><span class="toc-section-number">5.2</span> Dinámico</a></li>
<li><a href="#estático"><span class="toc-section-number">5.3</span> Estático</a></li>
<li><a href="#templates"><span class="toc-section-number">5.4</span> Templates</a></li>
</ul></li>
<li><a href="#validación"><span class="toc-section-number">6</span> Validación</a><ul>
<li><a href="#clases-de-dominio"><span class="toc-section-number">6.1</span> Clases de dominio</a></li>
<li><a href="#controladores"><span class="toc-section-number">6.2</span> Controladores</a></li>
<li><a href="#vistas"><span class="toc-section-number">6.3</span> Vistas</a></li>
</ul></li>
<li><a href="#crud"><span class="toc-section-number">7</span> CRUD</a><ul>
<li><a href="#create"><span class="toc-section-number">7.1</span> Create</a></li>
<li><a href="#read"><span class="toc-section-number">7.2</span> Read</a></li>
<li><a href="#update"><span class="toc-section-number">7.3</span> Update</a></li>
<li><a href="#delete"><span class="toc-section-number">7.4</span> Delete</a></li>
</ul></li>
<li><a href="#gorm-1"><span class="toc-section-number">8</span> GORM</a><ul>
<li><a href="#agregación-unidireccional"><span class="toc-section-number">8.1</span> Agregación (unidireccional)</a></li>
<li><a href="#agregacion-bidireccional"><span class="toc-section-number">8.2</span> Agregacion (bidireccional)</a></li>
<li><a href="#uno-a-uno-foreign-key"><span class="toc-section-number">8.3</span> Uno a uno (Foreign Key)</a></li>
<li><a href="#uno-a-muchos"><span class="toc-section-number">8.4</span> Uno a muchos</a></li>
<li><a href="#muchos-a-muchos"><span class="toc-section-number">8.5</span> Muchos a muchos</a></li>
</ul></li>
<li><a href="#quering"><span class="toc-section-number">9</span> Quering</a><ul>
<li><a href="#listados"><span class="toc-section-number">9.1</span> Listados</a></li>
<li><a href="#por-id"><span class="toc-section-number">9.2</span> Por ID</a></li>
<li><a href="#findby-y-findallby"><span class="toc-section-number">9.3</span> findBy y findAllBy</a></li>
<li><a href="#comparadores"><span class="toc-section-number">9.4</span> Comparadores</a></li>
<li><a href="#ejemplos"><span class="toc-section-number">9.5</span> Ejemplos</a></li>
</ul></li>
<li><a href="#servicios"><span class="toc-section-number">10</span> Servicios</a><ul>
<li><a href="#definición-1"><span class="toc-section-number">10.1</span> Definición</a></li>
<li><a href="#creación"><span class="toc-section-number">10.2</span> Creación</a></li>
<li><a href="#transaccionalidad"><span class="toc-section-number">10.3</span> Transaccionalidad</a></li>
<li><a href="#scope"><span class="toc-section-number">10.4</span> Scope</a></li>
<li><a href="#inyección"><span class="toc-section-number">10.5</span> Inyección</a></li>
</ul></li>
<li><a href="#configuración-log4j"><span class="toc-section-number">11</span> Configuración Log4j</a><ul>
<li><a href="#logging-levels"><span class="toc-section-number">11.1</span> Logging levels</a></li>
<li><a href="#artefactos"><span class="toc-section-number">11.2</span> Artefactos</a></li>
</ul></li>
<li><a href="#configuración-spring"><span class="toc-section-number">12</span> Configuración Spring</a><ul>
<li><a href="#iyección-normal"><span class="toc-section-number">12.1</span> Iyección normal</a></li>
<li><a href="#iyección-tests"><span class="toc-section-number">12.2</span> Iyección tests</a></li>
</ul></li>
<li><a href="#testing"><span class="toc-section-number">13</span> Testing</a><ul>
<li><a href="#unit-test"><span class="toc-section-number">13.1</span> Unit Test</a></li>
<li><a href="#integration-test"><span class="toc-section-number">13.2</span> Integration Test</a></li>
</ul></li>
<li><a href="#spring-security"><span class="toc-section-number">14</span> Spring Security</a><ul>
<li><a href="#instalación"><span class="toc-section-number">14.1</span> Instalación</a></li>
<li><a href="#configuración"><span class="toc-section-number">14.2</span> Configuración</a></li>
<li><a href="#uso"><span class="toc-section-number">14.3</span> Uso</a></li>
</ul></li>
</ul>
</nav>
<h1 id="acerca-de"><span class="header-section-number">1</span> Acerca de</h1>
<h2 id="autor"><span class="header-section-number">1.1</span> Autor</h2>
<p><strong>Adolfo Sanz De Diego</strong></p>
<ul>
<li><p>Correo: <a href="mailto:asanzdiego@gmail.com">asanzdiego@gmail.com</a></p></li>
<li><p>Twitter: <span class="citation" data-cites="asanzdiego">[@asanzdiego]</span>(http://twitter.com/asanzdiego)</p></li>
<li><p>Linkedin: <a href="http://www.linkedin.com/in/asanzdiego">http://www.linkedin.com/in/asanzdiego</a></p></li>
<li><p>Blog: <a href="http://asanzdiego.blogspot.com.es">http://asanzdiego.blogspot.com.es</a></p></li>
</ul>
<h2 id="licencia"><span class="header-section-number">1.2</span> Licencia</h2>
<p><strong>Este obra está bajo una licencia:</strong></p>
<ul>
<li><a href="http://creativecommons.org/licenses/by-sa/3.0/es/">Creative Commons Reconocimiento-CompartirIgual 3.0</a></li>
</ul>
<p><strong>El código fuente de los programas están bajo una licencia:</strong></p>
<ul>
<li><a href="http://www.viti.es/gnu/licenses/gpl.html">GPL 3.0</a></li>
</ul>
<h1 id="introducción"><span class="header-section-number">2</span> Introducción</h1>
<h2 id="grails"><span class="header-section-number">2.1</span> ¿Grails?</h2>
<p>Grails no sólo es un framework de desarrollo web, sino que es una <strong>plataforma completa de desarrollo</strong>:</p>
<ul>
<li><p>Contenedor/servidor web</p></li>
<li><p>Gestor de base de datos</p></li>
<li><p>Scaffolding</p></li>
<li><p>Empaquetado de la aplicación (war)</p></li>
<li><p>Realización de tests (unitarios, de integración, funcionales)</p></li>
<li><p>Extensible con plugins</p></li>
</ul>
<h2 id="paradigmas"><span class="header-section-number">2.2</span> Paradigmas</h2>
<p>Se basa en los paradigmas:</p>
<ul>
<li><p><strong>CoC</strong> (Convención sobre Configuración)</p></li>
<li><p><strong>DRY</strong> (Don’t Repeat Yourself)</p></li>
<li><p><strong>MVC</strong> (Modelo Vista Controlador)</p></li>
</ul>
<h2 id="gorm"><span class="header-section-number">2.3</span> GORM</h2>
<p>GORM (Grails Object Relational Mapping) sirve para el <strong>mapeo objeto-relacional</strong>:</p>
<ul>
<li><p>Uno a uno</p></li>
<li><p>Uno a muchos</p></li>
<li><p>Muchos a muchos</p></li>
</ul>
<h2 id="plugins"><span class="header-section-number">2.4</span> Plugins</h2>
<p>Existen multitud de <a href="http://grails.org/plugins/">plugins</a> que <strong>extienden la plataforma</strong>:</p>
<ul>
<li><p>Seguridad</p></li>
<li><p>AJAX</p></li>
<li><p>Búsqueda</p></li>
<li><p>Informes</p></li>
<li><p>etc.</p></li>
</ul>
<p>Se pueden crear plugins <strong>internos para funcionalidades comunes</strong> entre varias aplicaciones.</p>
<h2 id="nih-not-invented-here"><span class="header-section-number">2.5</span> NIH (Not Invented Here)</h2>
<div style="text-align:center">
<figure>
<img src="../img/grails-only-nih-transparente.png" alt="Grails NIH" /><figcaption>Grails NIH</figcaption>
</figure>
<h2 id="arquitectura"><span class="header-section-number">2.6</span> Arquitectura</h2>
<div style="text-align:center">
<img src="../img/grails-only-architecture-transparente.png" alt="Grails Arquitectura" />
</div>
<h1 id="instalación-y-configuración"><span class="header-section-number">3</span> Instalación y configuración</h1>
<h2 id="jdk"><span class="header-section-number">3.1</span> JDK</h2>
<ol type="1">
<li>Descargar.</li>
<li>Instalar/Descomprimir.</li>
<li>Variable de entorno y añadir al path.</li>
</ol>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">export</span> <span class="ot">JAVA_HOME=</span><span class="st">&quot;~/Java/jdk&quot;</span>
<span class="kw">export</span> <span class="ot">PATH=$PATH</span><span class="st">&quot;:&quot;</span><span class="ot">$JAVA_HOME</span><span class="st">&quot;/bin&quot;</span></code></pre>
<h2 id="groovy-sdk"><span class="header-section-number">3.2</span> Groovy-SDK</h2>
<ol type="1">
<li>Descargar.</li>
<li>Instalar/Descomprimir.</li>
<li>Variable de entorno y añadir al path.</li>
</ol>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">export</span> <span class="ot">GROOVY_HOME=</span><span class="st">&quot;~/Java/groovy&quot;</span>
<span class="kw">export</span> <span class="ot">PATH=$PATH</span><span class="st">&quot;:&quot;</span><span class="ot">$GROOVY_HOME</span><span class="st">&quot;/bin&quot;</span></code></pre>
<h2 id="grails-1"><span class="header-section-number">3.3</span> Grails</h2>
<ol type="1">
<li>Descargar.</li>
<li>Instalar/Descomprimir.</li>
<li>Variable de entorno y añadir al path.</li>
</ol>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">export</span> <span class="ot">GRAILS_HOME=</span><span class="st">&quot;~/Java/groovy&quot;</span>
<span class="kw">export</span> <span class="ot">PATH=$PATH</span><span class="st">&quot;:&quot;</span><span class="ot">$GRAILS_HOME</span><span class="st">&quot;/bin&quot;</span></code></pre>
<h2 id="probando"><span class="header-section-number">3.4</span> Probando</h2>
<pre><code>$ grails --version
Grails version: 2.2.1</code></pre>
<h1 id="getting-started"><span class="header-section-number">4</span> Getting Started</h1>
<h2 id="create-grails-project"><span class="header-section-number">4.1</span> Create Grails Project</h2>
<p>Por línea de comandos:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">grails</span> create-app my-project</code></pre>
<p>En el GGTS:</p>
<pre><code>File &gt; New &gt; Grails Project</code></pre>
<p>Línea de comandos en el GGTS:</p>
<pre><code>Control + Alt + Shift + G</code></pre>
<h2 id="directorios"><span class="header-section-number">4.2</span> Directorios</h2>
<pre><code>%PROJECT_HOME%
+ grails-app-&gt; ficheros de la aplicación grails
+ lib       -&gt; bibliotecas
+ scripts   -&gt; scripts
+ src
  + groovy  -&gt; otros ficheros groovy opcionales
  + java    -&gt; otros ficheros java opcionales
+ test      -&gt; clases de test
+ web-app
  + css     -&gt; archivos CSS
  + images  -&gt; archivos de imágenes
  + js      -&gt; archivos JavaScript
  + WEB-INF -&gt; otros ficheros de la aplicación web</code></pre>
<pre><code>%PROJECT_HOME%
+ grails-app
  + conf    -&gt; archivos de configuración
    + hibernate -&gt; archivos de configuración de hibernate
    + spring-&gt; archivos de configuración de spring
  + controllers -&gt; controladores
  + domain  -&gt; clases de dominio
  + i18n    -&gt; ficheros de internacionalización
  + services-&gt; servicios
  + taglib  -&gt; bibliotecas de etiquetas
  + util    -&gt; clases de utilidades
  + views   -&gt; vistas
    + layouts   -&gt; layouts</code></pre>
<h2 id="create-a-domain-class"><span class="header-section-number">4.3</span> Create a Domain Class</h2>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">grails</span> create-domain-class org.example.Libro</code></pre>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">package</span> org.example

<span class="kw">class</span> Libro {
  String titulo
  String author

  <span class="dt">static</span> constraints = {
    <span class="fu">titulo</span>(blank: <span class="kw">false</span>)
    <span class="fu">author</span>(blank: <span class="kw">false</span>)
  }
}</code></pre>
<h2 id="create-a-controller"><span class="header-section-number">4.4</span> Create a Controller</h2>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">grails</span> create-controller org.example.Libro</code></pre>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">package</span> org.example

<span class="kw">class</span> LibroController {
    def scaffold = Libro
}</code></pre>
<h2 id="creating-test-data"><span class="header-section-number">4.5</span> Creating Test Data</h2>
<p>grails-app/conf/BootStrap.groovy</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">import</span> org.example.Libro
<span class="kw">class</span> BootStrap {
  def init = { servletContext -&gt;
    <span class="co">// Check whether the test data already exists.</span>
    <span class="kw">if</span> (!Libro.<span class="fu">count</span>()) {
      <span class="kw">new</span> <span class="fu">Libro</span>(
        author: <span class="st">&quot;S. King&quot;</span>, 
        titulo: <span class="st">&quot;The Shining&quot;</span>).<span class="fu">save</span>(failOnError: <span class="kw">true</span>)
      <span class="kw">new</span> <span class="fu">Libro</span>(
        author: <span class="st">&quot;J. Patterson&quot;</span>,
        titulo: <span class="st">&quot;Along Came a Spider&quot;</span>).<span class="fu">save</span>(failOnError: <span class="kw">true</span>)
    }
  }

  def destroy = {
  }
}</code></pre>
<h2 id="start-grails"><span class="header-section-number">4.6</span> Start Grails</h2>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">grails</span> run-app</code></pre>
<h1 id="scaffolding"><span class="header-section-number">5</span> Scaffolding</h1>
<h2 id="definición"><span class="header-section-number">5.1</span> Definición</h2>
<p><strong>Generación automática de código</strong> para las cuatro operaciones básicas de cualquier aplicación (CRUD):</p>
<ul>
<li><p><strong>C</strong>reate</p></li>
<li><p><strong>R</strong>ead</p></li>
<li><p><strong>U</strong>pdate</p></li>
<li><p><strong>D</strong>elete</p></li>
</ul>
<h2 id="dinámico"><span class="header-section-number">5.2</span> Dinámico</h2>
<p>En el controlador:</p>
<pre class="sourceCode java"><code class="sourceCode java">def scaffold = <span class="kw">true</span> <span class="co">// si se sigue la convención de nombrado</span></code></pre>
<pre class="sourceCode java"><code class="sourceCode java">def scaffold = DomainClass <span class="co">// si no se sigue la convención de nombrado</span></code></pre>
<h2 id="estático"><span class="header-section-number">5.3</span> Estático</h2>
<p>Genera el controlador:</p>
<pre class="sourceCode java"><code class="sourceCode java">grails generate-controller org.<span class="fu">example</span>.<span class="fu">Libro</span></code></pre>
<p>Genera la vista:</p>
<pre class="sourceCode java"><code class="sourceCode java">grails generate-views org.<span class="fu">example</span>.<span class="fu">Libro</span></code></pre>
<p>Genera el controlador y la vista:</p>
<pre class="sourceCode java"><code class="sourceCode java">grails generate-all org.<span class="fu">example</span>.<span class="fu">Libro</span></code></pre>
<h2 id="templates"><span class="header-section-number">5.4</span> Templates</h2>
<p>Podemos extraer las templates de generación de código con el siguiente comando:</p>
<pre><code>grails install-templates</code></pre>
<p>Se pueden ver y modificar para su uso en la carpeta:</p>
<pre><code>%PROJECT_HOME%
+ src
  + templates
    + artifacts
    + scaffolding 
    + testing
    + war</code></pre>
<h1 id="validación"><span class="header-section-number">6</span> Validación</h1>
<h2 id="clases-de-dominio"><span class="header-section-number">6.1</span> Clases de dominio</h2>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> User {

  String email
  String password
  Integer age
  String twitter

  <span class="dt">static</span> constraints = {
    <span class="fu">email</span>(email:<span class="kw">true</span>, blank:<span class="kw">false</span>, unique:<span class="kw">true</span>)
    <span class="fu">password</span>(size:<span class="dv">5</span>..<span class="dv">15</span>, blank:<span class="kw">false</span>)
    <span class="fu">age</span>(range:<span class="dv">18</span>..<span class="dv">99</span>)
    <span class="fu">twitter</span>(url:<span class="kw">true</span>, nullable:<span class="kw">true</span>)
  }
}</code></pre>
<h2 id="controladores"><span class="header-section-number">6.2</span> Controladores</h2>
<pre class="sourceCode java"><code class="sourceCode java">def user = <span class="kw">new</span> <span class="fu">User</span>(params)
<span class="kw">if</span>(user.<span class="fu">validate</span>()) {
  <span class="co">// do something with user</span>
}
<span class="kw">else</span> {
  user.<span class="fu">errors</span>.<span class="fu">allErrors</span>.<span class="fu">each</span> {
    println it
  }
}</code></pre>
<h2 id="vistas"><span class="header-section-number">6.3</span> Vistas</h2>
<pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;g:hasErrors</span><span class="ot"> bean=</span><span class="st">&quot;${user}&quot;</span><span class="kw">&gt;</span>
  <span class="kw">&lt;ul&gt;</span>
    <span class="kw">&lt;g:eachError</span><span class="ot"> var=</span><span class="st">&quot;err&quot;</span><span class="ot"> bean=</span><span class="st">&quot;${user}&quot;</span><span class="kw">&gt;</span>
      <span class="kw">&lt;li&gt;</span>${err}<span class="kw">&lt;/li&gt;</span>
    <span class="kw">&lt;/g:eachError&gt;</span>
  <span class="kw">&lt;/ul&gt;</span>
<span class="kw">&lt;/g:hasErrors&gt;</span></code></pre>
<h1 id="crud"><span class="header-section-number">7</span> CRUD</h1>
<h2 id="create"><span class="header-section-number">7.1</span> Create</h2>
<pre class="sourceCode java"><code class="sourceCode java">def p = <span class="kw">new</span> <span class="fu">Persona</span>(nombre: <span class="st">&quot;Fred&quot;</span>, edad: <span class="dv">40</span>)
p.<span class="fu">save</span>()</code></pre>
<h2 id="read"><span class="header-section-number">7.2</span> Read</h2>
<pre class="sourceCode java"><code class="sourceCode java">def p = Persona.<span class="fu">get</span>(unaPersona.<span class="fu">id</span>)
assert <span class="dv">1</span> == p.<span class="fu">id</span></code></pre>
<h2 id="update"><span class="header-section-number">7.3</span> Update</h2>
<pre class="sourceCode java"><code class="sourceCode java">def p = Persona.<span class="fu">get</span>(unaPersona.<span class="fu">id</span>)
p.<span class="fu">nombre</span> = <span class="st">&quot;Bob&quot;</span>
p.<span class="fu">save</span>()</code></pre>
<h2 id="delete"><span class="header-section-number">7.4</span> Delete</h2>
<pre class="sourceCode java"><code class="sourceCode java">def p = Persona.<span class="fu">get</span>(unaPersona.<span class="fu">id</span>)
p.<span class="fu">delete</span>()</code></pre>
<h1 id="gorm-1"><span class="header-section-number">8</span> GORM</h1>
<h2 id="agregación-unidireccional"><span class="header-section-number">8.1</span> Agregación (unidireccional)</h2>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Cara {
  Nariz nariz
}

<span class="kw">class</span> Nariz {
  ...
}</code></pre>
<h2 id="agregacion-bidireccional"><span class="header-section-number">8.2</span> Agregacion (bidireccional)</h2>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Cara {
  Nariz nariz
}

<span class="kw">class</span> Nariz {
  <span class="dt">static</span> belongsTo = [face:Face]
}</code></pre>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">Cara</span>(nose:<span class="kw">new</span> <span class="fu">Nariz</span>()).<span class="fu">save</span>() <span class="co">// guarda ambos: Cara y Nariz</span>
<span class="kw">new</span> <span class="fu">Nariz</span>(face:<span class="kw">new</span> <span class="fu">Cara</span>()).<span class="fu">save</span>() <span class="co">// da error</span>
Face.<span class="fu">get</span>(faceId).<span class="fu">delete</span>() <span class="co">// borra ambos: Cara y Nariz</span></code></pre>
<h2 id="uno-a-uno-foreign-key"><span class="header-section-number">8.3</span> Uno a uno (Foreign Key)</h2>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Cara {
  <span class="dt">static</span> hasOne = [nose:Nose]

  <span class="co">// opcional, pero buena práctica</span>
  <span class="dt">static</span> constraints = {
    nariz unique: <span class="kw">true</span>
  }
}
<span class="kw">class</span> Nariz {
  Cara cara <span class="co">// crea una FK en la tabla de Nariz</span>
}</code></pre>
<h2 id="uno-a-muchos"><span class="header-section-number">8.4</span> Uno a muchos</h2>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Autor {
  <span class="dt">static</span> hasMany = [ libros : Libro ]
  String nombre
}
<span class="kw">class</span> Libro {
  String titulo
}</code></pre>
<p>Cascada al salvar y al actualizar pero no al borrar.</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Autor {
  <span class="dt">static</span> hasMany = [ libros : Libro ]
  String nombre
}
<span class="kw">class</span> Libro {
  <span class="dt">static</span> belongsTo = [ author: Autor ]
  String titulo
}</code></pre>
<p>Con belongsTo cascada al salvar, al actualizar y al borrar.</p>
<h2 id="muchos-a-muchos"><span class="header-section-number">8.5</span> Muchos a muchos</h2>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Autor {
  <span class="dt">static</span> hasMany = [libros:Libro]
  String nombre
}

<span class="kw">class</span> Libro {
  <span class="dt">static</span> belongsTo = Autor
  <span class="dt">static</span> hasMany = [authors:Autor]
  String titulo
}</code></pre>
<p>El belongsTo marca el &quot;propietario&quot; de la relación, en este caso el Autor.</p>
<p>Al salvar un Autor, se salvarán sus Libros, pero no al revés.</p>
<p>Recomiendan usar 2 relaciones uno a muchos, mejor que una relación muchos a muchos.</p>
<h1 id="quering"><span class="header-section-number">9</span> Quering</h1>
<h2 id="listados"><span class="header-section-number">9.1</span> Listados</h2>
<p>Todos los elementos:</p>
<pre class="sourceCode java"><code class="sourceCode java">def libros = Libro.<span class="fu">list</span>()</code></pre>
<p>Paginación:</p>
<pre class="sourceCode java"><code class="sourceCode java">def libros = Libro.<span class="fu">list</span>(offset:<span class="dv">10</span>, max:<span class="dv">20</span>)</code></pre>
<p>Ordenación</p>
<pre class="sourceCode java"><code class="sourceCode java">def libros = Libro.<span class="fu">list</span>(sort:<span class="st">&quot;title&quot;</span>, order:<span class="st">&quot;asc&quot;</span>)</code></pre>
<h2 id="por-id"><span class="header-section-number">9.2</span> Por ID</h2>
<pre class="sourceCode java"><code class="sourceCode java">def libro = Libro.<span class="fu">get</span>(<span class="dv">23</span>)</code></pre>
<pre class="sourceCode java"><code class="sourceCode java">def libros = Libro.<span class="fu">getAll</span>(<span class="dv">23</span>, <span class="dv">93</span>, <span class="dv">81</span>)</code></pre>
<h2 id="findby-y-findallby"><span class="header-section-number">9.3</span> findBy y findAllBy</h2>
<pre class="sourceCode java"><code class="sourceCode java">.<span class="fu">find</span>[All]<span class="fu">By</span>([Property][Comparator][And|Or])?[Property][Comparator]</code></pre>
<h2 id="comparadores"><span class="header-section-number">9.4</span> Comparadores</h2>
<p><strong>InList</strong> - Busca el valor dentro de la lista pasada por parámetro.</p>
<p><strong>LessThan</strong> - Menor que el valor pasado por parámetro.</p>
<p><strong>LessThanEquals</strong> - Menor o igual que el valor pasado por parámetro.</p>
<p><strong>GreaterThan</strong> - Mayor que el valor pasado por parámetro.</p>
<p><strong>GreaterThanEquals</strong> - Mayor o igual que el valor pasado por parámetro.</p>
<p><strong>Like</strong> - Equivalente al like de SQL.</p>
<p><strong>Ilike</strong> - Similar a Like sólo que no es sensible a las mayúsculas.</p>
<p><strong>NotEqual</strong> - No es igual al valor pasado por parámetro.</p>
<p><strong>Between</strong> - Entre dos valores (necesita dos parámetros).</p>
<p><strong>IsNotNull</strong> - Valor no nulo (no requiere ningún parámetro).</p>
<p><strong>IsNull</strong> - Valor nulo (no requiere ningún parámetro)</p>
<h2 id="ejemplos"><span class="header-section-number">9.5</span> Ejemplos</h2>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Libro {
    String titulo
    Date fecha
}</code></pre>
<pre class="sourceCode java"><code class="sourceCode java">def libro = Libro.<span class="fu">findByTitulo</span>(<span class="st">&quot;The Stand&quot;</span>)
def libros = Libro.<span class="fu">findAllByTituloLike</span>(<span class="st">&quot;Harry Pot%&quot;</span>)
libros = Libro.<span class="fu">findAllByFechaBetween</span>(primeraFecha, segundaFecha)
libros = Libro.<span class="fu">findAllByFechaGreaterThan</span>(someDate)
libros = Libro.<span class="fu">findAllByTituloOrFechaLessThan</span>(<span class="st">&quot;%titulo buscado%&quot;</span>, fechaBuscada)</code></pre>
<h1 id="servicios"><span class="header-section-number">10</span> Servicios</h1>
<h2 id="definición-1"><span class="header-section-number">10.1</span> Definición</h2>
<p>Se utilizan cuando necesitamos <strong>transacciones</strong> o cuando utilizamos varias <strong>clases de dominio</strong></p>
<h2 id="creación"><span class="header-section-number">10.2</span> Creación</h2>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">grails</span> create-service org.example.Libro</code></pre>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">package</span> org.example

<span class="kw">class</span> LibroService {
    
  def <span class="fu">doSomething</span>() {

    <span class="co">// do domething</span>
  }
}</code></pre>
<h2 id="transaccionalidad"><span class="header-section-number">10.3</span> Transaccionalidad</h2>
<p><strong>Por defecto son transaccionales</strong>, para deshabilitarlo:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="dt">static</span> transactional = <span class="kw">false</span></code></pre>
<h2 id="scope"><span class="header-section-number">10.4</span> Scope</h2>
<p><strong>Por defecto son singleton</strong>, pero podemos usar otros scopes:</p>
<ul>
<li><p><strong>prototype</strong> - Una instancia por cada inyección.</p></li>
<li><p><strong>request</strong> - Una instancia por cada request.</p></li>
<li><p><strong>flash</strong> - Una instancia para la request actual y la siguiente.</p></li>
<li><p><strong>flow</strong> - Una instancia por cada webflow.</p></li>
<li><p><strong>conversation</strong> - Una instancia por cada conversacion de un webflow.</p></li>
<li><p><strong>session</strong> - Una instancia por cada sesión.</p></li>
<li><p><strong>singleton</strong> - Una única instancia (por defecto).</p></li>
</ul>
<pre class="sourceCode java"><code class="sourceCode java"><span class="dt">static</span> scope = <span class="st">&quot;flow&quot;</span></code></pre>
<h2 id="inyección"><span class="header-section-number">10.5</span> Inyección</h2>
<p>Los servicios se pueden inyectar en los controladores.</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> LibroController {

  def libroService
  ...
}</code></pre>
<h1 id="configuración-log4j"><span class="header-section-number">11</span> Configuración Log4j</h1>
<h2 id="logging-levels"><span class="header-section-number">11.1</span> Logging levels</h2>
<ol type="1">
<li>off</li>
<li>fatal</li>
<li>error</li>
<li>warn</li>
<li>info</li>
<li>debug</li>
<li>trace</li>
<li>all</li>
</ol>
<h2 id="artefactos"><span class="header-section-number">11.2</span> Artefactos</h2>
<p>conf/Config.groovy</p>
<pre class="sourceCode java"><code class="sourceCode java">log4j = {

    <span class="co">// warn a todos los artefactos de nuestra aplicacion</span>
    warn <span class="st">&quot;grails.app&quot;</span>
    
    <span class="co">// debug a un controlador específico alojado en el paquete por defecto</span>
    debug <span class="st">&quot;grails.app.controllers.YourController&quot;</span>

    <span class="co">// debug a una clase de dominio específica</span>
    debug <span class="st">&quot;grails.app.domain.org.example.Book&quot;</span>

    <span class="co">// error a todos los taglibs</span>
    error <span class="st">&quot;grails.app.taglib&quot;</span>
    
    <span class="co">// info a tos los servicios</span>
    info <span class="st">&quot;grails.app.services&quot;</span>
}</code></pre>
<h1 id="configuración-spring"><span class="header-section-number">12</span> Configuración Spring</h1>
<h2 id="iyección-normal"><span class="header-section-number">12.1</span> Iyección normal</h2>
<p>conf/spring/resources.groovy</p>
<pre class="sourceCode java"><code class="sourceCode java">beans = {
    <span class="fu">rules</span>(org.<span class="fu">example</span>.<span class="fu">Rules</span>) {
        deltaAge = <span class="dv">5</span>
        deltaHeight = <span class="fl">0.1</span>
    }
}</code></pre>
<h2 id="iyección-tests"><span class="header-section-number">12.2</span> Iyección tests</h2>
<p>conf/spring/resources.groovy</p>
<pre class="sourceCode java"><code class="sourceCode java">defineBeans {
    <span class="fu">rules</span>(org.<span class="fu">example</span>.<span class="fu">Rules</span>) {
        deltaAge = <span class="dv">5</span>
        deltaHeight = <span class="fl">0.1</span>
    }
}</code></pre>
<h1 id="testing"><span class="header-section-number">13</span> Testing</h1>
<h2 id="unit-test"><span class="header-section-number">13.1</span> Unit Test</h2>
<p>Tienen que ser rápidos, no se ejecutan en el servidor, utilizan mocks.</p>
<p>Utilizan las anotaciones <span class="citation" data-cites="TestFor">@TestFor</span> y <span class="citation" data-cites="Mock">@Mock</span></p>
<h2 id="integration-test"><span class="header-section-number">13.2</span> Integration Test</h2>
<p>Se ejecutan en el servidor con datos reales.</p>
<p>Podemos utilizar el BootStrap para meter datos en la base de datos.</p>
<h1 id="spring-security"><span class="header-section-number">14</span> Spring Security</h1>
<h2 id="instalación"><span class="header-section-number">14.1</span> Instalación</h2>
<p>conf/BuildConfig.groovy</p>
<pre class="sourceCode java"><code class="sourceCode java">...
plugins {
  ...
  compile &#39;:spring-security-core:<span class="fl">1.2.7.3</span>&#39;
  ...
}</code></pre>
<h2 id="configuración"><span class="header-section-number">14.2</span> Configuración</h2>
<pre><code>grails refresh-dependencies</code></pre>
<pre><code>grails s2-quickstart org.example User Role</code></pre>
<h2 id="uso"><span class="header-section-number">14.3</span> Uso</h2>
<p>Se usa la anotación <span class="citation" data-cites="Secured">@Secured</span>(['ROLE_NAME']) tanto a nivel de clase como a nivel de método.</p>
<p>Se pueden usar tambien las siguientes reglas:</p>
<ul>
<li><p><strong>IS_AUTHENTICATED_ANONYMOUSLY</strong>: cualquiera puede entrar, incluso sin hacer login</p></li>
<li><p><strong>IS_AUTHENTICATED_REMEMBERED</strong>: sólo usuarios con login pueden entrar</p></li>
<li><p><strong>IS_AUTHENTICATED_FULLY</strong>: obliga a hacer login aunque tengas la cookie de remember</p></li>
</ul>
</body>
</html>
